# Обновление Directum

Заметки по результатам обновления в Directum с версии 4.9.1 на 5.2.1
в мае 2016 года.

## Общие сведения

Directum по сути не имеет центрального сервера.
Клиенты Directum самостоятельно обращаются к серверу MS SQL,
получают необходимые данные и обрабатывают их как считают нужным.

На сервере (или на серверах) запускаются только службы,
которые выполняют каждая свою узкую функцию:

### Session Server (SBSessionServer)

Проверяет количество лицензий и открывает (или нет) пользователю полноценный
доступ к SQL-серверу.

Не имеет настроек, требует наличия корректно сгенерированного ключа системы.

### Workflow Processing (SBWorkflowProcessingServer)

Фоновая обработка задач и заданий.

Если эта служба выключена, задачи будут создаваться,
но не дойдут до исполнителей.

Служба конфигурируется через файл
C:\Program Files (x86)\DIRECTUM Company\DIRECTUM 5.2\SBWorkflowSrvSettings.xml
где просто должны быть указаны все обслуживаемые ею базы данных.

Клиент Directum на сервер не ставится,
его функции становятся доступны после установки данной службы.

### Storage Service (SBFileStorageService)

Применяется для того, чтобы хранить тексты документов не в базе данных SQL,
а в папке, что резко сокращает нагрузку на сервер MS SQL.

В момент корректного обращения пользователя к конкретному файлу,
служба меняет права доступа и документ становится доступным через
стандартный механизм общих папок Windows.

Если служба не работает, Directum выглядит полностью работоспособным,
но при попытке увидеть текст документа, возникает ошибка.

Служба настраивается через файл
C:\Program Files (x86)\DIRECTUM Company\DIRECTUM 5.2\Storage Services\SBFileStorageSettings.xml
в нём также следует указать все БД, обслуживаемые службой.

В БД Directum также требуется указывать, что она обслуживается данной службой,
добавив её параметры в
Утилиты администратора / Администрирование хранилищ / Хранилища текстов документов

### Развёртывание БД

Обычно запуск новой БД (если все службы уже запущены и работают)
требует следующих шагов:

  * Восстановление БД из резервной копии
  * Активация БД (настройка служебных пользователей) утилитой
    SASystemActivator.exe
  * Регистрация системы, то есть получение ключа
    (лицензии на кол-во пользователей) и внесение его в БД утилитой
    SAKeyRegistration.exe
  * Подключение БД к службам Workflow и Storage по необходимости

## Предварительная настройка

### Версии Windows

Directum 5.2 не работает на Windows Server 2003,
а серверная часть к тому же на Windows XP.
Поэтому обновление производилось не "на месте", а на новый сервер
Windows Server 2008 R2.

### MS SQL

*До установки* MS SQL нужно убедиться, что на сервере установлена русская локаль
(Russia).

Можно устанавливать MS SQL в минимальной конфигурации,
однако есть смысл сразу же добавить к нему компоненту Full Text Search.
Это можно сделать и позже в любое время.

Рекомендуется дать права администратора SQL (sysadmin)
группе OMZGLOBAL\#modifyDIT
и право доступа на сервер (public) группе NT AUTHORITY\Authenticated Users.
Это позволит не создавать логины SQL-сервера для каждого пользователя.

Установка Directum зачастую требует переименования хоста с установленным MS SQL.
В этом случае *после* переименования требуется выполнить команду:

```sql
sp_dropserver <old_name>;
GO
sp_addserver <new_name>, local;
GO
```

Directum требует настройки:

```sql
sp_configure 'show advanced options', 1;
RECONFIGURE;
sp_configure 'clr enabled', 1;
RECONFIGURE;
```

Если планируется использовать (для администрирования) команду xp_cmdshell
(например `xp_cmdshell 'net use z: \\host\folder'`), её требуется разрешить:

```sql
EXEC sp_configure 'show advanced options', 1
GO
RECONFIGURE
GO
EXEC sp_configure 'xp_cmdshell', 1
RECONFIGURE
```

### Firewall

Требуется вручную открыть порты (Windows Firewall with Advanced Security)
для служб Directum и для MS SQL:

  * MS SQL:  1433
  * Session: 32300
  * Workflow:  32310
  * Storage: 32320

### IIS

Установку IIS следует делать по инструкции администратора Directum.
Суть: требуется установка компонент

  * ASP.Net
  * ASP
  * Management Service

Требуется добавить в MIME Types строку

  * mp4: video/mpeg

### Патч для канцелярии

До начала обновления Directum (в случае тестового обновления - до backup)
требуется сбить параметр
Утилиты разработчика / Типы справочников / РКК / Представления / Главное / Иерархия
на: `По журналам регистрации`

После обновления можно его вернуть на `По местам регистрации`.

### Ключи Directum

Убедитесь (на сайте https://support.directum.ru/) что имеется годное разрешение
на генерацию ключа.

## Установка / Обновление  

Выполняется согласно инструкции по обновлению Directum запуском STConverter.exe
и указанием пакета обновления Package\directum_to_521.dat

Параметры:

  * Конвертировать только разработку платформы
  * НЕ: Автоматически конвертировать,
    Автоматически разрешать конфликты импорта разработки системы
  * НЕ: Повторное сравнение разработки

Настройка вариантов запуска компонент:  SBLauncher.exe -CT=ComponentTokenDesigner

Запуск от имени Administrator, пакет Package\DIRECTUM52_tokens.xml

Настройка домена для пользователей (при помощи консоли MS SQL):

```sql
Update MBUser
Set Domain='OMZGLOBAL'
Where
  Domain is Null
  And NeedEncode = 'W'
  And UserStatus = 'П'
```

При помощи Проводника Directum:

  * Импорт записей справочников Роли Package\StandardData\РОЛ
  * Импорт типовых маршрутов Package\StandardData\ТМТ
    *Внимание!* Часть блоков может не заполниться (см. лог импорта),
    требуется донастроить их вручную
  * Импорт обложек из Package\StandardData\Обложки
    (Документы произвольной формы), в Установках WebFoldersAllowed = Y,
    уже должна быть запущена служба Storage

### Дополнительно для обновления с версии 4.9.1

Эти шаги тоже делаются согласно инструкции, вот они в краткой форме:

  * Шаг 1

    - Импорт записей справочников Package\StandardData\Currency

  * Шаг 2

    - Утилиты разработчика / Типовые маршруты / Канцелярия / Исполнение поручений / Параметры
      + Типовой маршрут для создания подчиненных поручений = Отправка подчиненного поручения на исполнение
      + Типовой маршрут для контроля исполнения = Контроль исполнения поручения (уже)
    - Утилиты разработчика / Типовые маршруты / Канцелярия / Контроль исполнения поручения / Параметры
      + Типовой маршрут для создания подчиненных поручений = Отправка подчиненного поручения на исполнение
    - Обложка Канцелярия
    - Агент создания периодических поручений (???)
    - Утилиты администратора / Администрирование хранилищ / Виды документов / * / Права по умолчанию
    - Импорт пользовательских сценариев Package\StandardData\РСЧ
    - Импорт записей справочников Package\StandardData\ВДС
    - Импорт пользовательских событий Package\StandardData\СОБ
    - Импорт записей справочников Package\StandardData\ReferenceAndDocumentAutotext

  * Шаг 3

    - Импорт записей справочника Package\StandardData\OTP
    - Утилиты администратора / Общее администрирование / Мастера действий / * / Параметры
      + Оформление заявления (отпуск/отгул/увольнение) ТМЗаявление = Утверждение заявления
      +  Оформление служебной записки. ТМ = Согласование служебных записок
    - Поручения по РКК + Поручения по обращениям -> Поручения
      + Package\AssignmentsAndTypicalAssignments
    	+ Справочник Настройки дополнительных реквизитов справочников: Настройки: Поручения по РКК  -> Поручения
    	+ Спрятать ссылку на Поручения по РКК
    - Доступ к отчётам Канцелярия группам:
  	  + Делопроизводители
  	  + Руководство
  	  + Руководители подразделения
  	  + Делопроизводители Обращения граждан и организаций
    - Справочник Соотношения полей карточки документа и записи справочника: Договорные документы Договоры Главное
    	+ Тип карточки документа = Договорные документы (уже)
    - Настройки системы / Обложка / Канцелярия
    	+ Исполнение поручений по РКК = Исполнение поручений (???)

  * Шаг 4
    - Справочник Правила вычисления ролей / ПомощникРуководителя для типовых маршрутов
    	+ Ничего не делаем (переносим из Роли Секретарь руководителя)

### Сервер ссылок Hyperlink

Устанавливается простым копированием в папку `C:\inetpub\wwwroot`.

Рекомендуется обращаться к ней через Default Web Site (привязанный к адресу *)
по ссылке вида http://directum.omzglobal.com/doc.asp?...

Настройка клиентов: Установки системы
  * MB_AWebServerName = directum.omzglobal.com

Пока гиперссылки не работают, обложки папок тоже работать не будут!

### Сервер веб-справки

Устанавливается по инструкции, для него создаётся отдельный Virtual site,
рекомендуется привязать его к хосту Directum.

Подключение клиентов выполняется через Установки системы
  * HelpServerName = http://directum/DIRECTUM

## Установка клиента Directum на пользовательские машины

Разработчик предлагает делать установку клиента при помощи msi пакета
(см. инструкцию администратора).

Однако в версии 5.2 в msi пакет не попал установщик SQL Native Client,
в результате чего свежеустановленный клиент Directum оказывается
неработоспособным на машинах с Windows XP.

Был разработан альтернативный вариант установки при помощи самописного скрипта
(конфигурируемого при помощи [файла YAML](../src/install/install.yml)),
запускающего стандартный установщик клиента Directum (Client.exe).

Для массового обновления клиентов в ночь обновления был дописан ещё
один [самописный скрипт](upgrade.bat), который проверяет наличие на машине
стандартной папки Directum v4.9.1, запускает его удаление при помощи msiexec
и передаёт управление скрипту установки. Факт попытки обновления журналируется.
Скрипт может быть запущен на все клиентские машины при помощи SCCM.

### Дополнительные клиентские компоненты

Дистрибутивы расположены в
`DIRECTUM Enterprise 5 2 1 с инструментом разработчика.zip`
(в папке \\DIRECTUM\F$\Directum\Distrib\5.2.1):

  * Конструктор документов - DocumentGenerator\DocumentGenerator-,,bit.exe
  * Интеграция с MS Office - OfficeInt\OfficeIntegration-??bit.exe

## Настройка после обновления

### Резервное копирование

Directum самостоятельно настраивает резервное копирование БД
в процессе установки.  
Рекомендуется его отключить (SQL Server Agent / Jobs) и настроить своё.

### Почтовые настройки Directum

В ходе обновления был отключён механизм рассылки через Microsoft Outlook
и настроена рассылка по протоколу SMTP как кардинально более простая.

Настройки заданы в константе MailOutgoingSettings
(или через пункт Почта на обложке Настройки системы),
используется пользователь OMZGLOBAL\directummail,
созданный специально для этой цели.

### Полнотекстовый поиск

Directum предлагает два вида полнотекстового поиска:

  * По текстам документов.
    Признан ненужным и не используется
  * По текстам задач и заданий

Второй тип поиска требует настройки (согласно инструкции):

  1. Однократного запуска сценария Индексирование текстов и слепков объектов
  2. Периодического регулярного запуска того же сценария

### Периодические задания

Directum требует массы периодических заданий.
Для их настройки используется стандартный Task Scheduler, в котором
заведена отдельная папочка Directum.

На данный момент настроены задания:

  * block - блокирование пользователей Directum, заблокированных в AD
  * ca - импорт сертификатов ЭЦП
  * fulltext - обновление полнотекстовых индексов
  * mail - рассылка уведомлений о заданиях
    (используется сценарий MailJobs, полученный правкой стандартного сценария
    Агент рассылки входящих заданий)
  * Выгрузка в 1С
  * Совещания

Тексты простых скриптов расположены в папке [tasks](tasks/).

Остальные скрипты - в папке [dist](../dist/).

## Скрипты для администрирования Directum

В ходе обновления был создан механизм написания сложных скриптов
для администрирования Directum.

Скрипты пишутся на языке [CoffeeScript](http://coffeescript.org/),
может быть также использован обычный JavaScript.
Исходные коды транслируются в JavaScript, собираются и дополнительно
сжимаются.

Написан и отлажен целый ряд утилит
(как командной строки, так и с графическим интерфейсом).
Возможно (и в большинстве случаев несложно) написание других под
возникающие задачи.

Исходные коды, готовые утилиты и краткие инструкции по сборке
расположены в репозитории
https://github.com/ukoloff/directum/

## Известные ошибки

Directum 5.2 гораздо хуже относится к дублированию кода системы.
Все экземпляры системы должны иметь разный код, даже если они
установлены на разных серверах.

Служба File Storage Service бывает самопроизвольно останавливается
и не запускается. Лечится удалением файлов
C:\Program Files (x86)\DIRECTUM Company\DIRECTUM 5.2\Storage Services\OpenedDocumentVersionInfoList*.cfg

### Очистка метаданных

Некоторые странные ошибки на клиенте
(включая вызванные совпадение кодов системы, но не только)
лечатся очисткой метаданных.

На клиентском компьютере выполняется (универсальный) скрипт:

``` bat
rd "%TEMP%\IS-Builder" /s /q
rd "%APPDATA%\NPO Computer\IS-Builder" /s /q
rd "%SystemDrive%\Documents and Settings\Default User\Application Data\NPO Computer\IS-Builder" /s /q
rd "%SystemDrive%\Users\Default\AppData\Roaming\NPO Computer\IS-Builder" /s /q
```

Очистку метададанных на стороне сервера лучше выполнять в нерабочее время:

  * Выполнить SQL: `Update SBMetadataLastUpdates Set LastUpdate = GETDATE(), Metadata = null`
  * Перезапустить сервер сеансов
  * Запустить сценарий "Обновление кэша метаданных"
