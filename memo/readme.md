# Обновление Directum

Заметки по результатам обновления в Directum с версии 4.9.1 на 5.2.1
в мае 2016 года.

## Предварительная настройка

### Версии Windows

Directum 5.2 не работает на Windows Server 2003,
а серверная часть к тому же на Windows XP.
Поэтому обновление производилось не "на месте", а на новый сервер
Windows Server 2008 R2.

### MS SQL

*До установки* MS SQL нужно убедиться, что на сервере установлена русская локаль
(Russia).

Можно устанавливать MS SQL в минимальной конфигурации,
однако есть смысл сразу же добавить к нему компоненту Full Text Search.
Это можно сделать и позже в любое время.

Рекомендуется дать права администратора SQL (sysadmin)
группе OMZGLOBAL\#modifyDIT
и право доступа на сервер (public) группе NT AUTHORITY\Authenticated Users.
Это позволит не создавать логины SQL-сервера для каждого пользователя.

Установка Directum зачастую требует переименования хоста с установленным MS SQL.
В этом случае *после* переименования требуется выполнить команду:

```sql
sp_dropserver <old_name>;
GO
sp_addserver <new_name>, local;
GO
```

Directum требует настройки:

```sql
sp_configure 'show advanced options', 1;
RECONFIGURE;
sp_configure 'clr enabled', 1;
RECONFIGURE;
```

Если планируется использовать (для администрирования) команду xp_cmdshell
(например `xp_cmdshell 'net use z: \\host\folder'`), её требуется разрешить:

```sql
EXEC sp_configure 'show advanced options', 1
GO
RECONFIGURE
GO
EXEC sp_configure 'xp_cmdshell', 1
RECONFIGURE
```

### Firewall

Требуется вручную открыть порты (Windows Firewall with Advanced Security)
для служб Directum и для MS SQL:

  * MS SQL:  1433
  * Session: 32300
  * Workflow:  32310
  * Storage: 32320

### IIS

Установку IIS следует делать по инструкции администратора Directum.
Суть: требуется установка компонент

  * ASP.Net
  * ASP
  * Management Service

Требуется добавить в MIME Types строку

  * mp4: video/mpeg

### Патч для канцелярии

До начала обновления Directum (в случае тестового обновления - до backup)
требуется сбить параметр
Утилиты разработчика / Типы справочников / РКК / Представления / Главное / Иерархия
на: `По журналам регистрации`

После обновления можно его вернуть на `по местам регистрации`.

### Ключи Directum

Убедитесь (на сайте https://support.directum.ru/) что имеется годное разрешение
на генерацию ключа.

## Установка / Обновление  

Выполняется согласно инструкции по обновлению Directum запуском STConverter.exe
и указанием пакета обновления Package\directum_to_521.dat

Параметры:

  * Конвертировать только разработку платформы
  * НЕ: Автоматически конвертировать, Автоматически разрешать конфликты импорта разработки системы
  * НЕ: Повторное сравнение разработки

Настройка вариантов запуска компонент:  SBLauncher.exe -CT=ComponentTokenDesigner

Запуск от имени Administrator, пакет Package\DIRECTUM52_tokens.xml

Настройка домена для пользователей (при помощи консоли MS SQL):

```sql
Update MBUser
Set Domain='OMZGLOBAL'
Where
  Domain is Null
  And NeedEncode = 'W'
  And UserStatus = 'П'
```

При помощи Проводника Directum:

  * Импорт записей справочников Роли Package\StandardData\РОЛ
  * Импорт типовых маршрутов Package\StandardData\ТМТ
    *Внимание!* Часть блоков может не заполниться (см. лог импорта),
    требуется донастроить их вручную
  * Импорт обложек из Package\StandardData\Обложки
    (Документы произвольной формы), в Установках WebFoldersAllowed = Y,
    уже должна быть запущена служба Storage

### Дополнительно для обновления с версии 4.9.1

Эти шаги тоже делаются согласно инструкции, вот они в краткой форме:

  * Шаг 1

    - Импорт записей справочников Package\StandardData\Currency

  * Шаг 2

    - Утилиты разработчика / Типовые маршруты / Канцелярия / Исполнение поручений / Параметры
      + Типовой маршрут для создания подчиненных поручений = Отправка подчиненного поручения на исполнение
      + Типовой маршрут для контроля исполнения = Контроль исполнения поручения (уже)
    - Утилиты разработчика / Типовые маршруты / Канцелярия / Контроль исполнения поручения / Параметры
      + Типовой маршрут для создания подчиненных поручений = Отправка подчиненного поручения на исполнение
    - Обложка Канцелярия
    - Агент создания периодических поручений (???)
    - Утилиты администратора / Администрирование хранилищ / Виды документов / * / Права по умолчанию
    - Импорт пользовательских сценариев Package\StandardData\РСЧ
    - Импорт записей справочников Package\StandardData\ВДС
    - Импорт пользовательских событий Package\StandardData\СОБ
    - Импорт записей справочников Package\StandardData\ReferenceAndDocumentAutotext

  * Шаг 3

    - Импорт записей справочника Package\StandardData\OTP
    - Утилиты администратора / Общее администрирование / Мастера действий / * / Параметры
      + Оформление заявления (отпуск/отгул/увольнение) ТМЗаявление = Утверждение заявления
      +  Оформление служебной записки. ТМ = Согласование служебных записок
    - Поручения по РКК + Поручения по обращениям -> Поручения
      + Package\AssignmentsAndTypicalAssignments
    	+ Справочник Настройки дополнительных реквизитов справочников: Настройки: Поручения по РКК  -> Поручения
    	+ Спрятать ссылку на Поручения по РКК
    - Доступ к отчётам Канцелярия группам:
  	  + Делопроизводители
  	  + Руководство
  	  + Руководители подразделения
  	  + Делопроизводители Обращения граждан и организаций
    - Справочник Соотношения полей карточки документа и записи справочника: Договорные документы Договоры Главное
    	+ Тип карточки документа = Договорные документы (уже)
    - Настройки системы / Обложка / Канцелярия
    	+ Исполнение поручений по РКК = Исполнение поручений (???)

  * Шаг 4
    - Справочник Правила вычисления ролей / ПомощникРуководителя для типовых маршрутов
    	+ Ничего не делаем (переносим из Роли Секретарь руководителя)

### Сервер ссылок Hyperlink

Устанавливается простым копированием в папку `C:\inetpub\wwwroot`.

Рекомендуется обращаться к ней через Default Web Site (привязанный к адресу *)
по ссылке вида http://directum.omzglobal.com/
(Установки системы MB_AWebServerName).

### Сервер веб-справки

Устанавливается по инструкции, для него создаётся отдельный Virtual site,
рекомендуется привязать его к хосту Directum.

Подключение клиентов выполняется через Установки системы
  * HelpServerName = http://directum/DIRECTUM
