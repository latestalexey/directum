0</*! :: See https://github.com/ukoloff/directum
@echo off
cscript.exe //nologo //e:javascript "%~f0" %* Directum/Directum
goto :EOF */0;
!function(n){function e(o){if(t[o])return t[o].exports;var r=t[o]={exports:{},id:o,loaded:!1};return n[o].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var t={};return e.m=n,e.c=t,e.p="",e(0)}([function(n,e,t){(function(n){n("Блокирование пользователей Directum v1.0.0 <https://github.com/ukoloff/directum>\n"),t(35)}).call(e,t(2))},function(n,e){n.exports="undefined"!=typeof WScript&&null!==WScript?WScript:null},function(n,e,t){(function(e){n.exports=function(){return e.Echo([].slice.apply(arguments).join(" "))}}).call(e,t(1))},function(n,e){n.exports=new ActiveXObject("WScript.Shell")},function(n,e){n.exports=function(n,e){var t,o,r;for("function"!=typeof e&&(r=[]),o=0,t=new Enumerator(n);!t.atEnd();){if(r)r.push(t.item());else if(!1===e(t.item(),o++))return;t.moveNext()}return r}},function(n,e){n.exports=new ActiveXObject("Scripting.FileSystemObject")},function(n,e,t){(function(n){var e,t,o;t=this.h,this.connect=function(n,e){return this.h=t=new ActiveXObject("ADODB.Connection"),t.Provider="SQLOLEDB",t.Open("Integrated Security=SSPI;Data Source="+n),e&&o(e),t},this.use=o=function(n){return t.DefaultDatabase="["+n+"]"},this.command=function(n){var e;return e=new ActiveXObject("ADODB.Command"),e.ActiveConnection=t,e.CommandText=n,e},this.fields=e=function(e){var t;if(!e.EOF)return t={},n(e.Fields,function(n){t[n.name]=n.value}),t},this.execute=function(n,t){var o,r,i,c;for(r=0,"function"!=typeof t&&(i=[]),c=n.Execute();!c.EOF;)if(o=e(c),c.MoveNext(),i)i.push(o);else if(!1===t(o,r++))return;return i}}).call(e,t(4))},function(n,e){var t,o,r=[].slice;n.exports=o=new Function("o,k,v","o(k)=v"),o.a=t=function(n,e){var t,r,i,c;for(t=r=0,i=e.length;i>r;t=++r)c=e[t],o(n,t,c);return n},o.l=function(){var n,e;return e=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t(e,n)},o.o=function(n,e){var t,r,i,c;for(c=t=0,i=e.length;i>t;c=++t)r=e[c],o(n,r,c);return n}},function(n,e,t){(function(e){n.exports=function(n){return null==n&&(n=0),e.Quit(n)}}).call(e,t(1))},function(n,e,t){(function(e,t){n.exports=e(t.Arguments)}).call(e,t(4),t(1))},function(n,e){n.exports=function(n){var e,t;for(null==n&&(n=12),t="";t.length<n;)e=Math.floor(62*Math.random()),t+=String.fromCharCode("Aa0".charCodeAt(e/26)+e%26);return t}},function(n,e,t){(function(n,e){var t,o,r,i,c,s;c=r=s=t=i=this.h,this.connect=function(){return this.info=c=new ActiveXObject("ADSystemInfo"),this.dc=r=c.DomainShortName,this.rootDSE=s=GetObject("LDAP://rootDSE"),this.base=t=s.Get("rootDomainNamingContext"),this.h=i=new ActiveXObject("ADODB.Connection"),i.Provider="ADsDSOObject",i.Open("Active Directory Provider"),i},this.cmd=o=function(e){var t;return t=new ActiveXObject("ADODB.Command"),t.ActiveConnection=i,n.o(t.Properties,{"Page Size":1e3,Searchscope:2}),t.CommandText=e,t},this.user=function(n){var e;return e=o("<LDAP://"+t+">;(&(objectCategory=user)(sAMAccountName="+n.replace(/[()*\\]/g,"\\$&")+"));*;subTree").Execute(),e.EOF?void 0:GetObject(e(0).Value)},this.photo=function(n){var t,o;if(null!=n.thumbnailPhoto)n=n.thumbnailPhoto;else{if(null==n.jpegPhoto)return;n=n.jpegPhoto}return t=new ActiveXObject("ADODB.Stream"),t.Type=1,t.Open(),t.Write(n),t.SaveToFile(o=e(),2),t.Close(),o}}).call(e,t(7),t(14))},,function(n,e,t){(function(e,t,o,r){var i,c;i=function(){return e("Запуск: "+t.ScriptName+" <Server>/<Database>\n\nНапример: "+t.ScriptName+" Directum/Directum\n\nУмолчания можно дописать в 3 строку файла.\n\nПодробности на <https://github.com/ukoloff/directum>."),o(1)},n.exports=c=function(){var n,e,t;for(r.length||i(),n=0,e=r.length;e>n;n++)t=r[n],/^\w+\/\w+/.test(t)||i();return t=r[0].split("/"),{s:t[0],d:t[1]}}()}).call(e,t(2),t(1),t(8),t(9))},function(n,e,t){(function(e,t,o){var r;r=e.ExpandEnvironmentStrings("%TEMP%"),n.exports=function(){var n,e,i;for(n=e=1;16>=e;n=++e)if(!t.FileExists(i=t.BuildPath(r,o())))return i;throw Error("Cannot create temporary file")}}).call(e,t(3),t(5),t(10))},,,,,,,,,,,,,,,,,,,function(n,e,t){(function(n,e){var t;t=function(t,o){return n(t),e.command(o).Execute()},t("Закрытие неактивных записей справочника Пользователи","Update MBAnalit\nSet Sost='З'\nFrom MBUser As U, MBAnalit As A, MBVidAn As R\nWhere U.UserStatus='О' And U.NeedEncode='W'\n  And A.Dop=U.UserKod And A.Sost<>'З'\n  And A.Vid=R.Vid And R.Kod='ПОЛ'"),t("Открытие заново активированных записей справочника Пользователи","Update MBAnalit\nSet Sost='Д'\nFrom MBUser As U, MBAnalit As A, MBVidAn As R\nWhere U.UserStatus<>'О' And U.NeedEncode='W'\n  And A.Dop=U.UserKod And A.Sost='З'\n  And A.Vid=R.Vid And R.Kod='ПОЛ'"),t("Копирование статуса строк справочника Пользователи в справочник Работники","Update W\nSet Sost=U.Sost\nFrom MBAnalit As U, MBAnalit As W, MBVidAn As R, MBUser As X\nWhere R.Kod='РАБ' And W.Vid=R.Vid\n  And W.Polzovatel=U.Analit And W.Sost<>U.Sost\n  And U.Dop=X.UserKod And X.NeedEncode='W'"),t("Копирование статуса строк справочника Работники в справочник Персоны","Update P\nSet Sost=W.Sost\nFrom MBAnalit As P, MBAnalit As W, MBVidAn As R\nWhere R.Kod='РАБ' And W.Vid=R.Vid\n  And W.Persona=P.Analit\n  And W.Sost<>P.Sost")}).call(e,t(2),t(6))},function(n,e,t){(function(n,e,t,o){var r,i,c,s,u,a;if(n("Поиск заблокированных пользователей"),a=[],r=e.command("Select\n UserID, UserKod, UserName, UserLogin\nFrom MBUser\nWhere\n NeedEncode='W'\n And UserStatus<>'О'\n And UserCategory='О'"),e.execute(r,function(n){var e;return 2&(null!=(e=t.user(n.UserLogin))?e.userAccountControl:void 0)?a.push(n):void 0}),n("Найдено: "+a.length),a.length){for(r=e.command("Update MBUser\nSet\n UserStatus='О'\nWhere UserID=?"),s=[],i=0,c=a.length;c>i;i++)u=a[i],s.push(u.UserLogin),o.l(r,u.UserID).Execute();n("Заблокированы: "+s.join(", "))}}).call(e,t(2),t(6),t(11),t(7))},function(n,e,t){(function(n,e,o,r){n("Соединяемся с mssql://"+e.s+"/"+e.d),o.connect(e.s,e.d),n("Соединяемся с Active Directory"),r.connect(),t(34),t(33),t(37),t(36),n("That's all folks!")}).call(e,t(2),t(13),t(6),t(11))},function(n,e,t){(function(n,e,t){var o,r,i,c,s,u,a;for(n("Поиск удаляемых логинов SQL"),o=e.command("Select name\nFrom master..syslogins\nWhere name in\n  (Select '"+t.dc+"\\'+UserLogin Collate Cyrillic_General_CI_AS\n   From MBUser\n   Where UserStatus='О' And NeedEncode='W')"),a=[],e.execute(o,function(n){return a.push(n.name)}),a.length&&n("Удаляем: "+a.join(", ")),c=0,s=a.length;s>c;c++){u=a[c];try{e.h.sp_revokelogin(u)}catch(i){r=i,n("#"+r.message)}}}).call(e,t(2),t(6),t(11))},function(n,e,t){(function(n,e,t){var o,r,i,c,s,u,a;for(n("Поиск удаляемых пользователей SQL"),o=e.command("Select\n  name\nFrom sysusers\nWhere name in\n  (Select UserKod\n    From MBUser\n    Where UserStatus='О' And NeedEncode='W')"),a=[],e.execute(o,function(n){return a.push(n.name)}),a.length&&(n("Удаляем: "+a.join(", ")),o=e.command("Declare @sql nvarchar(max);\nSelect @sql = '';\n\nSelect @sql = @sql + 'Drop Table ' +\n  QUOTENAME(TABLE_SCHEMA) + '.' + QUOTENAME(TABLE_NAME) + ';'\nFrom INFORMATION_SCHEMA.TABLES\nWhere TABLE_SCHEMA = ?\n  And TABLE_TYPE ='BASE TABLE';\n\nexec sp_executesql @sql;")),c=0,s=a.length;s>c;c++){u=a[c];try{t.l(o,u).Execute(),e.h.sp_dropuser(u)}catch(i){r=i,n("#"+r.message)}}}).call(e,t(2),t(6),t(7))}]);
